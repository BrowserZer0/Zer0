name: Build Linux

on:
  workflow_dispatch:
    inputs:
      upload_to_release:
        description: 'Upload to existing v1.0.0 release'
        required: false
        default: 'true'
        type: boolean

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-0 libnss3 libasound2t64 libgbm1 libxss1

    - name: Download Tor Expert Bundle for Linux
      run: |
        mkdir -p resources/lin/tor
        cd resources/lin
        curl -LO https://archive.torproject.org/tor-package-archive/torbrowser/15.0/tor-expert-bundle-linux-x86_64-15.0.tar.gz || \
        curl -LO https://dist.torproject.org/torbrowser/15.0/tor-expert-bundle-linux-x86_64-15.0.tar.gz
        tar -xzf tor-expert-bundle-linux-x86_64-15.0.tar.gz -C tor --strip-components=1 || tar -xzf tor-expert-bundle-linux-x86_64-15.0.tar.gz
        ls -la tor/
        
    - name: Install dependencies
      run: npm install
      
    - name: Build Linux packages
      run: npm run build-linux
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        CI: false
        
    - name: List build artifacts
      run: ls -la dist/
        
    - name: Upload Linux build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: zero-browser-linux
        path: |
          dist/*.deb
          dist/*.AppImage
        retention-days: 30

    - name: Upload to Release
      if: ${{ inputs.upload_to_release == 'true' }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.0
        files: |
          dist/*.deb
          dist/*.AppImage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
